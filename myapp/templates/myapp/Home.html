{% extends 'myapp/base.html' %}
{% load static %}

{% block title %} Home page {% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="main-content">

    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="message {{ message.tags }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="das">
        <div class="dashb">
            <h2>Dashboard</h2>
            <p>Welcome to Your Account!!</p>
            <button class="btn-pri"> <i class="fa-solid fa-circle-plus"></i> Add Transaction</button>
        </div>

<div class="cards">
    <div class="card">
        <p>Total Balance</p>
        <div class="value">Rs. {{ balance|floatformat:2 }}</div>
        <p>{% if balance >= 0 %}Safe spending{% else %}Over budget{% endif %}</p>
    </div>

    <div class="card">
        <p>Monthly Income</p>
        <div class="value positive">Rs. {{ total_income|floatformat:2 }}</div>
        <p>Current Total</p>
    </div>

    <div class="card">
        <p>Monthly Expenses</p>
        <div class="value negative">Rs. {{ total_expense|floatformat:2 }}</div>
        <p>Current Total</p>
    </div>
</div>
        <div class="mid-grid">
         <div class="chart-card">
    <h3>Expenses by Category</h3>
    <p>Breakdown of your spending</p>
    
    <div style="height: 200px; margin-bottom: 20px;">
        <canvas id="categoryChart"></canvas>
    </div>
<div class="legend">
    {% for item in category_data %}
    <div class="legend-item" style="display: flex; align-items: center; margin-bottom: 8px;">
        <span class="dot" style="height: 12px; width: 12px; border-radius: 50%; margin-right: 10px; background-color: 
            {% if forloop.counter0 == 0 %}#1e3a8a{% elif forloop.counter0 == 1 %}#60a5fa{% elif forloop.counter0 == 2 %}#93c5fd{% elif forloop.counter0 == 3 %}#bfdbfe{% elif forloop.counter0 == 4 %}#2563eb{% else %}#3b82f6{% endif %};">
        </span>
        <span style="font-size: 0.9rem;">
            <strong>{{ item.category }}:</strong> Rs. {{ item.total|default:0 }}
            <strong>{{ item.category }}:</strong> Rs. {{ item.total|floatformat:2 }}
        </span>
    </div>
    {% endfor %}
</div>
</div>

          <div class="quick-card">
    <h3>Quick Stats</h3>
    <p>This month's overview</p>
    <div class="qs-row">
    <span>Net Change</span>
    <span class="stat-net-change {% if net_change >= 0 %}green{% else %}red{% endif %}">
        {% if net_change >= 0 %}+{% endif %}{{ net_change|floatformat:2 }}
    </span>
</div>
<div class="progress-bar"> <div class="progress-fill" style="width: {% if total_income > 0 %}{{ total_expense|divisibleby:total_income }}{% else %}0{% endif %}%"></div> </div>
<div class="qs-row">
    <span>Total Transactions</span>
    <span class="stat-total-count">{{ total_count }}</span>
</div>
<div class="qs-row">
    <span>Average Expense</span>
    <span class="stat-avg-expense green">Rs. {{ avg_transaction|floatformat:2 }}</span>
</div>
<div class="qs-row">
    <span>Largest Expense</span>
    <span class="stat-largest-expense red">Rs. {{ largest_expense|floatformat:2 }}</span>
</div>

        <span>Net Change</span>
        <span class="{% if net_change >= 0 %}green{% else %}red{% endif %}">
            {% if net_change >= 0 %}+{% endif %}{{ net_change|floatformat:2 }}
        </span>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" style="width: {% if total_income > 0 %}{{ total_expense|divisibleby:total_income }}{% else %}0{% endif %}%"></div>
    </div>
    <div class="qs-row">
        <span>Total Transactions</span>
        <span>{{ total_count }}</span>
    </div>
    <div class="qs-row">
        <span>Average Expense</span>
        <span class="green">Rs. {{ avg_transaction|floatformat:2 }}</span>
    </div>
    <div class="qs-row">
        <span>Largest Expense</span>
        <span class="red">Rs. {{ largest_expense|floatformat:2 }}</span>
    </div>
</div>
        </div>

        <div class="receipt-card">
            <h3>Scan Receipt</h3>
            <p>Upload a receipt to automatically extract transaction details</p>
            <button class="scan-btn" onclick="document.getElementById('receiptInput').click()">
                Start Receipt Scanner
            </button>
            <input type="file" id="receiptInput" accept="image/*" capture="environment" style="display:none">
        </div>

        <div class="table-card">
    <h3>Recent Transactions</h3>
  <table>
    <thead>
        <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Action</th> 
        </tr>
    </thead>
    
    <tbody>
        {% for trans in transactions %}
        <tr data-id="{{ trans.id }}" data-type="{{ trans.transaction_type }}">
            <td>{{ trans.date|date:"M d, Y" }}</td>
            <td>{{ trans.category }}</td>
            <td>{{ trans.transaction_type }}</td>
            <td class="{% if trans.transaction_type == 'Expense' %}negative{% else %}positive{% endif %}">
                Rs. {{ trans.amount }}
            </td>
            <td>
                <i class="fas fa-trash delete-transactionhome" style="cursor:pointer;color:rgb(18, 18, 18);"></i>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5">No transactions found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Type</th>
                <th>Amount</th>
            </tr>
        </thead>
        
        <tbody>
            {% for trans in transactions %}
            <tr>
                <td>{{ trans.date|date:"M d, Y" }}</td>
                <td>{{ trans.category }}</td>
                <td>{{ trans.transaction_type }}</td>
                <td class="{% if trans.transaction_type == 'Expense' %}negative{% else %}positive{% endif %}">
                    Rs. {{ trans.amount }}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4">No transactions found.</td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
</div>
    </div>

    <div id="trans-mo" class="addtran">
        <div class="addtran-content">
            <span class="closebtn">&times;</span>
            <h2>Add Transaction</h2>
            <form method="POST">
                {% csrf_token %}

                <label>Amount</label>
                <input type="number" step="0.01" name="amount" placeholder="Enter amount" required>

                <label>Type</label>
                <select name="transaction_type" id="type-select">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>

                <label>Category</label>
                <select name="category" id="category-select">
                    </select>

                <label>Date</label>
                <input type="date" name="date" id="transactionkoDate">

                <button type="submit" class="submit-btn">Add Transaction</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %} 
<link rel="stylesheet" href="{% static 'myapp/css/Home.css' %}">
{% endblock %}

{% block extra_js %}
<script>

    
    // 1. Initialize Date
    document.getElementById("transactionkoDate").value = new Date().toISOString().split('T')[0];

    // 2. Dynamic Category Logic
    const typeSelect = document.getElementById('type-select');
    const categorySelect = document.getElementById('category-select');

    const categories = {
        expense: ["Food & Dining", "Transport", "Groceries", "Housing", "Utilities", "Entertainment", "Others"],
        income: ["Salary", "Freelance", "Investment", "Gift", "Bonus", "Others"]
    };

    function updateCategories() {
        const selectedType = typeSelect.value;
        const options = categories[selectedType];
        categorySelect.innerHTML = '';
        options.forEach(cat => {
            const el = document.createElement('option');
            el.value = cat;
            el.textContent = cat;
            categorySelect.appendChild(el);
        });
    }

    typeSelect.addEventListener('change', updateCategories);
    updateCategories();

    const openBtn = document.querySelector(".btn-pri");
    const modal = document.getElementById("trans-mo");
    const closeBtn = document.querySelector(".closebtn");

    openBtn.onclick = () => modal.style.display = "flex";
    closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };
//scanner
document.getElementById("receiptInput").addEventListener("change", function() {
    const file = this.files[0];
    if (!file) return;

 //   alert("Scanning receipt... please wait.");

    const formData = new FormData();
    formData.append("receipt", file);

    fetch("/scan-receipt/", {  // Ensure this URL matches your urls.py path
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            alert("Success! Added Rs. " + data.amount + " to your records.");
            window.location.reload(); // Refresh to see new data in dashboard
        } else {
            alert("Error: " + data.error);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Scanner failed. Check terminal for errors.");
    });
});
const ctx = document.getElementById('categoryChart').getContext('2d');
window.categoryChartInstance = new Chart(ctx, {
new Chart(ctx, {
    type: 'pie',
    data: {
        labels: [{% for item in category_data %}"{{ item.category|safe }}",{% endfor %}],
        datasets: [{
            data: [{% for item in category_data %}{{ item.total|floatformat:2 }},{% endfor %}],
            backgroundColor: [
                '#1e3a8a','#60a5fa','#93c5fd','#bfdbfe','#2563eb','#3b82f6','#a5b4fc'
                '#1e3a8a', 
                '#60a5fa', // Light Blue (Slice 2)
                '#93c5fd', // Sky Blue (Slice 3)
                '#bfdbfe', // Pale Blue (Slice 4)
                '#2563eb', // Royal Blue (Slice 5)
                '#3b82f6', // Medium Blue (Slice 6)
                '#a5b4fc'  // Indigo (Slice 7)
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
    }
});

document.addEventListener("click", function(e) {
    if (e.target.classList.contains("delete-transactionhome")) {
        const row = e.target.closest("tr");
        const id = row.dataset.id;
        const type = row.dataset.type;

        if (!confirm("Delete this transaction?")) return;

        fetch("{% url 'delete_transactionhome' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ id: id, type: type })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                row.remove();

                // Update cards
                document.querySelector(".cards .value").innerText = "Rs. " + data.balance.toFixed(2);
                document.querySelector(".cards .value.positive").innerText = "Rs. " + data.total_income.toFixed(2);
                document.querySelector(".cards .value.negative").innerText = "Rs. " + data.total_expense.toFixed(2);

                // Update quick stats
                document.querySelector(".stat-net-change").innerText = (data.balance >= 0 ? "+" : "") + data.balance.toFixed(2);
                document.querySelector(".stat-total-count").innerText = data.total_count;
                document.querySelector(".stat-avg-expense").innerText = "Rs. " + data.avg_transaction.toFixed(2);
                document.querySelector(".stat-largest-expense").innerText = "Rs. " + data.largest_expense.toFixed(2);

                // Update progress bar
                document.querySelector(".progress-fill").style.width = parseFloat(data.progress_percentage).toFixed(1) + "%";

                // Update category chart
                if (window.categoryChartInstance) {
                    window.categoryChartInstance.data.labels = data.category_data.map(c => c.category);
                    window.categoryChartInstance.data.datasets[0].data = data.category_data.map(c => parseFloat(c.total));
                    window.categoryChartInstance.update();
                }

            } else {
                alert(data.error);
            }
        })
        .catch(err => console.error(err));
    }
});



        plugins: {
            legend: { display: false } 
        }
    }
});
</script>
{% endblock %}