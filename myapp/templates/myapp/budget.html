{% extends 'myapp/base.html' %}
{% load static %}
{% block title %} Budget Page {% endblock %}
{% block content %}

  <div class="container">
    <div class="header">
      <h2>Budget Management</h2>
      <p class="subtitle">Track your spending and manage your monthly budget</p>
    </div>

   
    <!-- Available to Spend Card -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2>Available to Spend</h2>
          <p class="card-subtitle">Your remaining budget for this month</p>
        </div>
        <div class="month-selector">
          <button class="nav-btn" onclick="updateMonth(-1)" aria-label="Previous month">&#8249;</button>
          <span class="current-month"></span>
          <button class="nav-btn" onclick="updateMonth(1)" aria-label="Next month">&#8250;</button>
        </div>
      </div>

      <div class="amount-display">
        <div class="remaining-amount">Rs. {{ remaining_total }}</div>
        <div class="spent-info">
          <span>Rs. {{ total_spent}} of Rs. {{ total_budget }} spent</span>
          <span class="percentage">{{ total_percent }}% </span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill {% if b.is_over %}over{% endif %}" style="width: {% if total_percent > 100 %}100{% else %}{{ total_percent }}{% endif %}%"></div>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-item">
          <div class="stat-label">Total Budget</div>
          <div class="stat-value">Rs. {{ total_budget }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Total Spent</div>
          <div class="stat-value">Rs. {{ total_spent }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Recommended Limit (70%)</div>
          <div class="stat-value">Rs. {{ recommended_limit }}</div>
        </div>
      </div>
      {% if allocation_warning %}
      <div class="allocation-warning">
        <i class="fas fa-exclamation-triangle"></i>
        Your planned categories exceed 70% of your income. Consider reducing some limits to save more!
      </div>
      {% else %}
      <div class="no-allocation-warning">
        <i class="fas fa-check"></i>
        Your budget allocations remain within 70% of your income, reflecting responsible financial planning.
      </div>
      {% endif %}
    </div>



    <!-- Budget Categories -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2>Budget Categories</h2>
          <p class="card-subtitle">Track spending across different categories</p>
        </div>
        <button class="add-btn"  id="category-add">
          <span class="btn-icon">+</span>
          Add Category
        </button>
      </div>

    <dialog class="budgetForms" id="addCategoryForm">
    <form method="POST" action="{% url 'budget' %}">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="add_category">
    <input type="hidden" id="form-month" name="month" value="{{ request.GET.month|default:now.month }}">
    <input type="hidden" id="form-year" name="year" value="{{ request.GET.year|default:now.year }}">

    
    <div class="form-info">
      <p class="first-text">Add Category</p><br>
      <p class="second-text">Add a new budget</p>
    </div>
    <hr>
    
    <div class="budget-form">
      <label for="category">Category name</label><br>
      <select name="category" required>
        <option>Food & Dining</option>
        <option>Transport</option>
        <option>Groceries</option>
        <option>Housing</option>
        <option>Utilities</option>
        <option>Entertainment</option>
        <option>Others</option>
      </select>
    </div>

    <div class="budget-form">
      <label for="amount"> Monthly Budget Amount </label><br>
      <input type="number" name="amount" step="0.01" placeholder="0.00" required>
    </div>

    <div class="budget-form">
      <label for="icon"> Icon </label><br>
      <select name="icon">
        <option value="üí∞">üí∞ Money</option>
        <option value="üçî">üçî Food</option>
        <option value="üöó">üöó Transport</option>
        <option value="üè†">üè† Housing</option>
        <option value="üé¨">üé¨ Fun</option>
      </select>
    </div>

    <div class="budgetform-actions">
      <button type="button" class="cancel-button" onclick="this.closest('dialog').close()">Cancel</button>
      <button type="submit" class="submit-button">Add Category</button>
    </div>
  </form>
</dialog>

    <div class="categories-list">
  {% for b in budget_data %}
    <div class="category-item {% if b.is_over %}over-budget{% endif %}">
      
      <div class="category-header">
        <div class="category-info">
          <div class="category-icon">{{ b.icon }}</div>
          <div>
            <div class="category-name">
              {{ b.category }}
              {% if not b.has_budget %}
                <span style="font-size: 0.75em; background: #ff6b6b; color: white; padding: 2px 8px; border-radius: 12px; margin-left: 8px;">No Budget</span>
              {% endif %}
            </div>
            <div class="category-spent">
              Rs. {{ b.spent }} {% if b.has_budget %} of Rs. {{ b.amount }} {% endif %}
            </div>
          </div>
        </div>

        <div class="category-right">
          <div>
            <div class="category-remaining {% if b.is_over %}negative{% else %}positive{% endif %}">
              {% if b.has_budget %}
                Rs. {{ b.remaining }}
              {% else %}
                <span style="font-size: 0.85em;">Set Budget</span>
              {% endif %}
            </div>
            <div class="category-status">
              {% if not b.has_budget %}
                Unbudgeted
              {% elif b.is_over %}
                Over budget
              {% else %}
                Remaining
              {% endif %}
            </div>
          </div>
          {% if b.has_budget %}
            <button class="edit-btn" data-id="{{ b.id }}" data-category="{{ b.category }}" data-amount="{{ b.amount }}">‚öôÔ∏è Edit</button>
            <form method="POST" action="{% url 'delete_budget' %}" onsubmit="return confirm('Delete this budget?');" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="budget_id" value="{{ b.id }}">
            <button type="submit" class="delete-btn">üóëÔ∏èDelete</button>
            </form>
          {% else %}
            <button class="edit-btn set-budget-btn" data-category="{{ b.category }}">‚ûï Set Budget</button>
          {% endif %}
        </div>
      </div>

      <div class="category-progress">
        <div class="category-progress-bar">    
          <div class="category-progress-fill {% if b.is_over %}over{% endif %}" style="width: {% if b.percent > 100 %}100{% else %}{{ b.percent }}{% endif %}%" >
          </div>
        </div>
        <span class="usage-label">
          {% if b.has_budget %}
          {{ b.percent }}% used
          {% else %}
          Rs. {{ b.spent }} spent (no budget)
          {% endif %}</span>
      </div>

    </div>
  {% empty %}
    <p style="text-align:center; opacity:0.6;">
      No expenses recorded for this month yet.
    </p>
   {% endfor %}
</div>

   <dialog id="editForm" class="budgetForms">
    <form method="POST" action="{% url 'edit_budget' %}">
        {% csrf_token %}
        <input type="hidden" name="budget_id" id="edit-budget-id">
        
        <div class="form-info">
            <p class="first-text" id="edit-category-label">Edit Budget</p>
        </div>

        <div class="budget-form">
            <label> Monthly Limit:</label>
            <input type="number" name="amount" id="edit-amount-input" step="0.01" required>
        </div>

        <div class="budgetform-actions">
            <button type="button" class="cancel-button" onclick="this.closest('dialog').close()">Cancel</button>
            <button type="submit" class="submit-button">Save Changes</button>
        </div>
    </form>
</dialog>
</div>

    <!-- Money Flow Tracker -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2>Money Flow Tracker</h2>
          <p class="card-subtitle">Track money you owe and money owed to you</p>
        </div>
        <button class="add-btn" id="party-add">
          <span class="btn-icon">+</span>
          Add Party
        </button>
      </div>
<dialog class="budgetForms" id="addPartyForm">
<form method="POST" action="{% url 'budget' %}">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="add_party">

    <div class="form-info">
      <p class="first-text">Add Money Flow</p><br>
      <p class="second-text">Track money you owe or money owed to you</p>
    </div>
    <hr>

    <div class="budget-form">
      <label for="person_name"> Name </label><br>
      <input type="text" name="person_name" placeholder="Enter person's name" required>
    </div>

    <div class="budget-form">
      <label for="amount"> Amount </label><br>
      <input type="number" name="amount" step="0.01" placeholder="0.00" required>
    </div>

    <div class="budget-form">
      <label for="flow_type">Type</label><br>
      <select name="flow_type">
        <option value="topay">You owe</option>
        <option value="toreceive">Owed to you</option>
      </select>
    </div>

    <div class="budgetform-actions">
      <button type="button" class="cancel-button" onclick="this.closest('dialog').close()">Cancel</button>
      <button type="submit" class="submit-button">Add</button>
    </div>
  </form>
</dialog>

    
    
      <div class="money-flow-content">
        <div class="money-flow-center">
        <!-- You Owe -->
        <div class="flow-column">
          <div class="flow-header">
            <div class="flow-icon error-icon">‚ö†Ô∏è</div>
            <span class="flow-title">You Owe</span>
            <span class="flow-total error" id="you-owe-total">Rs. {{ you_owe_total }}</span>
          </div>
          
          <div class="flow-list" id="you-owe-list">
            {% for item in you_owe_list %}
            <div class="flow-item" data-flow-id="{{ item.id }}">
              <div class="person-icon">üë§</div>
              <span class="person-name">{{ item.person_name }}</span>
              <span class="person-amount error"> Rs. {{ item.amount }}</span>
              <button class="remove-btn" data-flow-id="{{ item.id }}" aria-label="Remove">√ó</button>
            </div>
            {% endfor %}
          </div>
        </div>


        <!-- Owed to You -->
        <div class="flow-column">
          <div class="flow-header">
            <div class="flow-icon success-icon">‚úì</div>
            <span class="flow-title">Owed to You</span>
            <span class="flow-total success" id="owed-to-you-total">Rs. {{ owed_to_you_total }}</span>
          </div>
          
          <div class="flow-list" id="owed-to-you-list">
            {% for item in owed_to_you_list %}
            <div class="flow-item" data-flow-id="{{ item.id }}">
              <div class="person-icon">üë§</div>
              <span class="person-name">{{ item.person_name }}</span>
              <span class="person-amount success"> Rs. {{ item.amount }}</span>
              <button class="remove-btn" data-flow-id="{{ item.id }}" aria-label="Remove">√ó</button>
            </div>
            {% endfor %} 
          </div>
        </div>
      </div>
      
      <div class="net-flow">
        <span class="net-flow-icon">üíµ</span>
        <span class="net-flow-label">Net Money Flow</span>
        <span class="net-flow-amount success" id="net-flow-amount">Rs. {{ net_flow }}</span>
      </div>
  </div>
  {% endblock %}

{% block extra_css %} 
    <link rel="stylesheet" href="{% static 'myapp/css/budget.css' %}">
{% endblock %}

{% block extra_js %}
<script>
const months=[
'January','February','March','April','May','June','July','August','September','October','November','December'];

let currentMonth = {{ current_month|default:now.month }} - 1;
let currentYear = {{ current_year|default:now.year }};

function updateDisplay(){
  document.querySelector(".current-month").textContent=`${months[currentMonth]}  ${currentYear}`;
}

function updateMonth(sign){
  currentMonth+=sign;
  
  if(currentMonth>11){
    currentMonth=0;
    currentYear++;
  }

  else if(currentMonth<0){
    currentMonth=11;
    currentYear--;
  }
 
  window.location.href = `/budget/?month=${currentMonth+1}&year=${currentYear}`;
  updateDisplay();

}
updateDisplay();




 document.addEventListener("DOMContentLoaded",()=>{

  const categoryAdd=document.querySelector("#category-add");
  const editBtn=document.querySelectorAll(".edit-btn");
  const partyAdd=document.querySelector("#party-add");
  const addCategoryForm=document.querySelector("#addCategoryForm");
  const editForm=document.querySelector("#editForm");
  const addPartyForm=document.querySelector("#addPartyForm");
  const dialog=document.querySelectorAll("dialog");

  
  const editIdInput = document.querySelector("#edit-budget-id");
  const editAmountInput = document.querySelector("#edit-amount-input");
  const editCategoryLabel = document.querySelector("#edit-category-label");

editBtn.forEach(btn => {
    btn.addEventListener("click", () => {
        if (btn.classList.contains('set-budget-btn')) {
        const category = btn.getAttribute("data-category");
        document.getElementById("form-month").value = currentMonth;
        document.getElementById("form-year").value = currentYear;
        
        // Pre-select the category in the add form
        const categorySelect = addCategoryForm.querySelector('select[name="category"]');
        for (let option of categorySelect.options) {
          if (option.value === category) {
            option.selected = true;
            break;
          }
        }
        
        addCategoryForm.showModal();
        return;
      }

        const budgetId = btn.getAttribute("data-id");
        const category = btn.getAttribute("data-category");
        const amount = btn.getAttribute("data-amount");

        
        editIdInput.value = budgetId;
        editAmountInput.value = amount;
        editCategoryLabel.innerText = "New limit for " + category;

      
        editForm.showModal();
    });
});
  if(categoryAdd){
  categoryAdd.addEventListener("click",()=>{
    document.getElementById("form-month").value = currentMonth;
    document.getElementById("form-year").value = currentYear;
    addCategoryForm.showModal();
  });
  }

  partyAdd.addEventListener("click",()=>{
    addPartyForm.showModal();
  });

  dialog.forEach(dialog=>{
  dialog.addEventListener("click",(e)=>{
    if( e.target===dialog){
      dialog.close();}
  });
  });

  document.querySelector(".money-flow-content").addEventListener("click", async (e) => {
  if (e.target.classList.contains("remove-btn")) {
    const flowItem = e.target.closest(".flow-item");
    const flowId = e.target.getAttribute("data-flow-id");
      
      if (confirm("Remove this entry?")) {
        try {
          const response = await fetch("/delete_money_flow/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ flow_id: flowId })
          });

          const data = await response.json();
          
          if (data.success) {
            // Remove from DOM
            flowItem.remove();
            
            // Update totals
            document.getElementById("you-owe-total").textContent = `Rs. ${data.you_owe_total}`;
            document.getElementById("owed-to-you-total").textContent = `Rs. ${data.owed_to_you_total}`;
            document.getElementById("net-flow-amount").textContent = `Rs. ${data.net_flow}`;
          } else {
            alert("Error: " + data.error);
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Failed to delete entry");
        }
      }
    }
  });
});


</script>
{% endblock %}

    
