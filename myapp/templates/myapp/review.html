{% extends 'myapp/base.html' %}
{% load static %}

{% block title %} Review Page {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'myapp/css/review.css' %}">
{% endblock %}

{% block content %}
<div class="review-page">

    <div class="page-header">
        <h2 style="font-size: 28px;">Review Transactions</h2>
        <p style="font-size: 20px;">Search, filter, and analyze your transaction history</p>
    </div>


 
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('transactions')">Transactions</button>
        <button class="tab-btn" onclick="openTab('ai-insights')">AI Insights</button>
    </div>

    <div id="transactions-view">
        <div class="summary-grid">
            <div class="card">
                <h4 class="summary-title">Filtered Total</h4>
                <div class="summary-amount" id="filteredTotal">₹ {{ filtered_total }}</div>
                <div class="summary-count" id="totalCount">{{ total_count }} transactions</div>
            </div>
            <div class="card">
                <h4 class="summary-title">Filtered Income</h4>
                <div class="summary-amount blue" id="incomeTotal">₹ {{ total_income }}</div>
                <div class="summary-count" id="incomeCount">{{ income_count }} transactions</div>
            </div>
            <div class="card">
                <h4 class="summary-title">Filtered Expenses</h4>
                <div class="summary-amount red" id="expenseTotal">₹ {{ total_expense }}</div>
                <div class="summary-count" id="expenseCount">{{ expense_count }} transactions</div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="card filter-section">
            <div class="filter-header">
                <h3><i class="fas fa-filter"></i> Filters & Search</h3>
                <p>Narrow down your transaction history</p>
            </div>
            <div class="search-row">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search transactions...">
            </div>
            <div class="filter-controls">
                <div class="filter-group">
                    <label>Type</label>
                    <select id="typeSelect">
                        <option value="All Types">All Types</option>
                        <option value="Income">Income</option>
                        <option value="Expense">Expense</option>
                   
                    </select>
                </div>
                <div class="filter-group">
                    <label>Category</label>
                    <select id="categorySelect">
                        <option value="All Categories">All Categories</option>
                        <option value="Groceries">Groceries</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Freelance">Freelance</option>
                        <option value="Housing">Housing</option>
                
                    </select>
                </div>
                <div class="filter-group">
                    <label>Sort By</label>
                    <select id="sortFilter">
                        <option value="date_desc">Date Desc</option>
                        <option value="date_asc">Date Asc</option>
                        <option value="amount_desc">Amount Desc</option>
                        <option value="amount_asc">Amount Asc</option>
                        <option value="type_asc">Type Asc</option>
                        <option value="type_desc">Type Desc</option>
                    
                    </select>
                </div>
                <div class="filter-group action-group">
                    <label>Actions</label>
                    <button class="clear-btn">Clear Filters</button>
                </div>
            </div>
        </div>

        <div id="transactions-list">
            {% for t in transactions %}
            <div class="trans-item" data-id="{{ t.id }}" data-type="{{ t.transaction_type }}">
                <div class="trans-icon {% if t.transaction_type == 'Expense' %}red-bg{% else %}blue-bg{% endif %}">
                    <i class="fas {% if t.transaction_type == 'Expense' %}fa-shopping-cart{% else %}fa-hand-holding-usd{% endif %}"></i>
                </div>
                <div class="trans-details">
                    <div class="trans-name">
                        {{ t.description|default:t.category }}
                        <span class="badgerev gray">{{ t.category }}</span>
                    </div>
                    <div class="trans-date">{{ t.date }}</div>
                </div>
                <div class="trans-amount {% if t.transaction_type == 'Expense' %}red{% else %}green{% endif %}">
                    {% if t.transaction_type == 'Expense' %}-{% else %}+{% endif %}₹{{ t.amount }}
                </div>
                <div class="trans-delete">
                    <i class="fas fa-trash delete-transaction"></i>
                </div>
            </div>
            {% empty %}
            <p>No transactions found.</p>
            {% endfor %}
        </div>
    </div>

    <div id="ai-insights-view" style="display: none;">
        <div class="ai-banner">
            <div class="ai-icon"><i class="fas fa-robot"></i></div>
            <div>
                <h3>AI Financial Insights</h3>
                <p>Powered by intelligent analysis of your spending patterns</p>
            </div>
        </div>

        <div class="bento-grid">
            <div class="card insight-blue">
                <div class="card-header">
                    <span class="card-title">Monthly Spending Forecast</span>
                    <span class="badgerev purple">Prediction</span>
                </div>
                <p class="card-text">Based on your current spending pattern, you're projected to spend <strong>₹{{ ai.monthly_forecast.projected_total }}</strong> this month. This is ₹{{ ai.monthly_forecast.avg_daily }} per day on average.</p>
            </div>

            <div class="card insight-green-1">
                <div class="card-header">
                    <span class="card-title">Spending Trend: {{ ai.spending_trend.trend }}</span>
                    <span class="badgerev green">Trend</span>
                </div>
                <p class="card-text">Your spending has {{ ai.spending_trend.trend|lower }} by <strong>{{ ai.spending_trend.percentage }}%</strong> compared to your earlier transactions. Keep tracking your goals!</p>
            </div>

            <div class="card insight-orange">
                <div class="card-header">
                    <span class="card-title">Top Spending: {{ ai.top_category.name }}</span>
                    <span class="badgerev orange">Category</span>
                </div>
                <p class="card-text">{{ ai.top_category.name }} accounts for <strong>₹{{ ai.top_category.amount }} ({{ ai.top_category.percentage }}%)</strong> of your total expenses. Consider if this aligns with your priorities.</p>
            </div>

            <div class="card insight-green-2">
                <div class="card-header">
                    <span class="card-title">Savings Rate Analysis</span>
                    <span class="badgerev teal">Savings</span>
                </div>
                <p class="card-text">You're currently saving <strong>{{ ai.savings_rate }}%</strong> of your income. Financial experts recommend saving at least 20% of your income for long-term health.</p>
            </div>
        </div>

        <div class="insight-section">
            <h3 class="section-title-icon"><i class="far fa-lightbulb icon-green"></i> Personalized Recommendations</h3>
            <p class="section-subtitle">Smart suggestions to improve your financial health</p>
            
            <div class="recommendation-card mb-20">
                <div class="recommendation-content">
                    <i class="fas fa-seedling icon-teal-sm"></i>
                    <div>
                        <h4 class="recommendation-title">Optimize {{ ai.top_category.name }} Spending</h4>
                        <p class="recommendation-text">Your {{ ai.top_category.name }} expenses are currently your highest. Look for ways to reduce costs in this category or set a stricter budget.</p>
                    </div>
                </div>
                <a href="{% url 'budget' %}" class="review-link">→ Review category budget</a>
            </div>

            <div class="recommendation-card">
                <div class="recommendation-content">
                    <i class="fas fa-chart-line icon-teal-sm"></i>
                    <div>
                        <h4 class="recommendation-title">Boost Your Savings Rate</h4>
                        <p class="recommendation-text">Your current rate is {{ ai.savings_rate }}%. Keep it up! Aiming for a higher percentage will help you reach your goals faster.</p>
                    </div>
                </div>
                <a href="{% url 'goals' %}" class="review-link">→ Boost your goals</a>
            </div>
        </div>

        <hr class="section-divider">

        <div class="insights-dual-container">
            <div class="card projection-panel-full">
                <div class="card-header-icon">
                    <i class="far fa-calendar-alt icon-purple-bg"></i>
                    <h4>End of Month Projection</h4>
                </div>
                <p class="projection-note-small">Based on your current spending pace</p>
                
                <div class="projection-flex">
                    <div>
                        <h5 class="projection-summary-title">Current Spending</h5>
                        <div class="projection-amount">₹{{ ai.monthly_forecast.current_spent }}</div>
                    </div>
                    <div style="text-align: right;">
                        <h5 class="projection-summary-title">Projected Total</h5>
                        <div class="projection-amount blue-text">₹{{ ai.monthly_forecast.projected_total }}</div>
                    </div>
                </div>

                <div class="days-left-container">
                    <i class="far fa-clock"></i> {{ ai.monthly_forecast.days_remaining }} days remaining • ₹{{ ai.monthly_forecast.avg_daily }}/day average
                </div>
            </div>

            <div class="card category-analysis-panel">
                <h3 class="section-title-plain">Category Spending Analysis</h3>
                <p class="section-subtitle">Your top spending categories</p>

                <div class="category-list">
                    {% for item in ai.category_breakdown %}
                    <div class="category-item">
                        <span class="category-rank">{{ forloop.counter }}</span>
                        <div class="category-details">
                            <div class="category-name">{{ item.category }}</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar progress-green" style="width: {{ item.percentage }}%;"></div>
                            </div>
                        </div>
                        <div class="category-value">
                            <strong>₹{{ item.amount }}</strong>
                            <span class="category-percentage">{{ item.percentage }}%</span>
                        </div>
                    </div>
                    {% empty %}
                    <p>No expense data available.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
        
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.querySelector(".search-input");
        const typeSelect = document.getElementById("typeSelect");
        const categorySelect = document.getElementById("categorySelect");
        const sortSelect = document.getElementById("sortFilter");

        function fetchFilteredTransactions() {
            const search = searchInput.value;
            const type = typeSelect.value;
            const category = categorySelect.value;
            const sort = sortSelect.value;  

            const params = new URLSearchParams({ search, type, category, sort });

            fetch("{% url 'filter_transactions' %}?" + params.toString())
                .then(res => res.json())
                .then(data => {
                    renderTransactions(data.transactions);
                    updateSummary(data);
                });
        }

        function renderTransactions(transactions) {
            const container = document.getElementById("transactions-list");
            container.innerHTML = ""; 

            if (transactions.length === 0) {
                container.innerHTML = "<p>No transactions found.</p>";
                return;
            }

            transactions.forEach(t => {
                const html = `
                <div class="trans-item" data-id="${t.id}" data-type="${t.transaction_type}">
                    <div class="trans-icon ${t.transaction_type === "Expense" ? "red-bg" : "blue-bg"}">
                        <i class="fas ${t.transaction_type === "Expense" ? "fa-shopping-cart" : "fa-hand-holding-usd"}"></i>
                    </div>
                    <div class="trans-details">
                        <div class="trans-name">
                            ${t.description}
                            <span class="badgerev gray">${t.category}</span>
                        </div>
                        <div class="trans-date">${t.date}</div>
                    </div>
                    <div class="trans-amount ${t.transaction_type === "Expense" ? "red" : "green"}">
                        ${t.transaction_type === "Expense" ? "-" : "+"}₹${t.amount.toFixed(2)}
                    </div>
                    <div class="trans-delete">
                        <i class="fas fa-trash delete-transaction"></i>
                    </div>
                </div>`;
                container.insertAdjacentHTML("beforeend", html);
            });
        }

        function updateSummary(data) {
            document.getElementById("filteredTotal").innerText = "₹ " + data.filtered_total.toFixed(2);
            document.getElementById("incomeTotal").innerText = "₹ " + data.total_income.toFixed(2);
            document.getElementById("expenseTotal").innerText = "₹ " + data.total_expense.toFixed(2);
            document.getElementById("incomeCount").innerText = data.income_count + " transactions";
            document.getElementById("expenseCount").innerText = data.expense_count + " transactions";
            document.getElementById("totalCount").innerText = data.total_count + " transactions";
        }

        searchInput.addEventListener("input", fetchFilteredTransactions);
        typeSelect.addEventListener("change", fetchFilteredTransactions);
        categorySelect.addEventListener("change", fetchFilteredTransactions);
        sortSelect.addEventListener("change", fetchFilteredTransactions);

        document.querySelector(".clear-btn").addEventListener("click", () => {
            searchInput.value = "";
            typeSelect.value = "All Types";
            categorySelect.value = "All Categories";
            fetchFilteredTransactions();
        });
    });

    function openTab(tabName) {
        const transactionsView = document.getElementById('transactions-view');
        const aiView = document.getElementById('ai-insights-view');
        const buttons = document.querySelectorAll('.tab-btn');

        if(tabName === 'transactions') {
            transactionsView.style.display = 'block';
            aiView.style.display = 'none';
            buttons[0].classList.add('active');
            buttons[1].classList.remove('active');
        } else {
            transactionsView.style.display = 'none';
            aiView.style.display = 'block';
            buttons[0].classList.remove('active');
            buttons[1].classList.add('active');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        openTab('transactions');
    });

    document.addEventListener("click", function (e) {
        if (e.target.classList.contains("delete-transaction")) {
            const row = e.target.closest(".trans-item");
            const id = row.dataset.id;
            const type = row.dataset.type;

            if (!confirm("Delete this transaction?")) return;

            fetch("{% url 'delete_transaction' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ id: id, type: type })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    row.remove();
                    document.getElementById("filteredTotal").innerText = "₹" + data.filtered_total.toFixed(2);
                    document.getElementById("incomeTotal").innerText = "₹" + data.total_income.toFixed(2);
                    document.getElementById("expenseTotal").innerText = "₹" + data.total_expense.toFixed(2);
                    document.getElementById("incomeCount").innerText = data.income_count + " transactions";
                    document.getElementById("expenseCount").innerText = data.expense_count + " transactions";
                    document.getElementById("totalCount").innerText = data.total_count;
                } else {
                    alert(data.error);
                }
            });
        }
    });
function openTab(tabName) {
    const transactionsView = document.getElementById('transactions-view');
    const aiView = document.getElementById('ai-insights-view');
    const buttons = document.querySelectorAll('.tab-btn');

    if(tabName === 'transactions') {
        transactionsView.style.display = 'block';
        aiView.style.display = 'none';
        buttons[0].classList.add('active');
        buttons[1].classList.remove('active');
    } else {
        transactionsView.style.display = 'none';
        aiView.style.display = 'block';
        buttons[0].classList.remove('active');
        buttons[1].classList.add('active');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    openTab('transactions');
});
</script>
{% endblock %}